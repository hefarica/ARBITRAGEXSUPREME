# üöÄ ArbitrageX Supreme - Gu√≠a de Pruebas de Rendimiento

**Ingenio Pichichi S.A. - Documentaci√≥n de Testing de Performance Empresarial**

> "Cumplidor, disciplinado, organizado" - Metodolog√≠a aplicada en todas las pruebas sin mocks

---

## üìã √çndice

1. [Introducci√≥n](#introducci√≥n)
2. [Arquitectura de Testing](#arquitectura-de-testing)
3. [Tipos de Pruebas](#tipos-de-pruebas)
4. [Configuraci√≥n del Entorno](#configuraci√≥n-del-entorno)
5. [Ejecuci√≥n de Pruebas](#ejecuci√≥n-de-pruebas)
6. [An√°lisis de Resultados](#an√°lisis-de-resultados)
7. [Optimizaci√≥n de Rendimiento](#optimizaci√≥n-de-rendimiento)
8. [CI/CD Integration](#cicd-integration)
9. [Monitoreo Continuo](#monitoreo-continuo)
10. [Troubleshooting](#troubleshooting)

---

## üéØ Introducci√≥n

Este sistema de pruebas de rendimiento est√° dise√±ado espec√≠ficamente para ArbitrageX Supreme, siguiendo las mejores pr√°cticas empresariales del Ingenio Pichichi S.A. Todas las pruebas son **100% funcionales sin mocks**, garantizando validaci√≥n real del sistema de trading DeFi.

### Objetivos Principales

- ‚úÖ **Validar latencia** de APIs cr√≠ticas de trading (< 500ms P95)
- ‚úÖ **Verificar throughput** m√≠nimo de 100 req/s para operaciones cr√≠ticas
- ‚úÖ **Confirmar estabilidad** de conexiones WebSocket en tiempo real
- ‚úÖ **Evaluar rendimiento** de integraciones blockchain multi-cadena
- ‚úÖ **Detectar degradaci√≥n** antes de impacto en producci√≥n

### M√©tricas Clave

| M√©trica | Umbral Cr√≠tico | Umbral Objetivo | Descripci√≥n |
|---------|----------------|-----------------|-------------|
| **API Latencia P95** | < 1000ms | < 500ms | Tiempo de respuesta trading APIs |
| **Error Rate** | < 5% | < 1% | Tasa de errores HTTP 5xx |
| **Throughput** | > 50 req/s | > 100 req/s | Requests por segundo sostenidos |
| **WebSocket Latency** | < 200ms | < 100ms | Latencia mensajes tiempo real |
| **Blockchain P95** | < 5000ms | < 2000ms | Respuesta de RPCs blockchain |

---

## üèóÔ∏è Arquitectura de Testing

### Componentes del Sistema

```
üìÅ performance/
‚îú‚îÄ‚îÄ üìÅ k6/
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ config/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ test-config.js          # Configuraci√≥n centralizada
‚îÇ   ‚îî‚îÄ‚îÄ üìÅ tests/
‚îÇ       ‚îú‚îÄ‚îÄ üìÑ api-load-test.js        # Pruebas APIs principales
‚îÇ       ‚îú‚îÄ‚îÄ üìÑ websocket-test.js       # Pruebas WebSocket
‚îÇ       ‚îî‚îÄ‚îÄ üìÑ blockchain-stress-test.js # Pruebas blockchain
‚îú‚îÄ‚îÄ üìÅ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ üìÑ run-performance-tests.sh    # Automatizaci√≥n ejecuci√≥n
‚îú‚îÄ‚îÄ üìÅ monitoring/
‚îÇ   ‚îî‚îÄ‚îÄ üìÑ performance-dashboard.json  # Dashboard Grafana
‚îî‚îÄ‚îÄ üìÅ results/                        # Resultados hist√≥ricos
```

### Stack Tecnol√≥gico

- **üîß k6**: Engine de pruebas de carga
- **üìä Prometheus**: M√©tricas y alertas
- **üìà Grafana**: Visualizaci√≥n y dashboards
- **üîÑ GitHub Actions**: CI/CD automatizado
- **üêö Bash Scripts**: Automatizaci√≥n y orchestraci√≥n

---

## üß™ Tipos de Pruebas

### 1. Smoke Tests (Pruebas de Humo)
**Prop√≥sito**: Verificaci√≥n b√°sica de funcionalidad
- **Duraci√≥n**: 30 segundos
- **VUs**: 1 usuario virtual
- **Frecuencia**: Cada deployment

```bash
./performance/scripts/run-performance-tests.sh \
  --environment development \
  --test-type smoke
```

### 2. Load Tests (Pruebas de Carga)
**Prop√≥sito**: Comportamiento bajo carga normal
- **Duraci√≥n**: 5 minutos
- **VUs**: 10-50 usuarios virtuales
- **Escenarios**: Ramping up gradual

```bash
./performance/scripts/run-performance-tests.sh \
  --environment staging \
  --test-type load
```

### 3. Stress Tests (Pruebas de Estr√©s)
**Prop√≥sito**: Identificar l√≠mites del sistema
- **Duraci√≥n**: 15 minutos
- **VUs**: 50-200 usuarios virtuales
- **Objetivo**: Encontrar punto de quiebre

### 4. WebSocket Tests
**Prop√≥sito**: Validar comunicaci√≥n tiempo real
- **Conexiones simult√°neas**: 100+
- **Duraci√≥n**: 5-10 minutos
- **M√©tricas**: Latencia mensajes, estabilidad conexiones

### 5. Blockchain Tests
**Prop√≥sito**: Rendimiento integraciones multi-cadena
- **Redes**: Ethereum, Polygon, Arbitrum, Optimism, Base
- **Operaciones**: Quotes, gas estimation, price oracles

---

## ‚öôÔ∏è Configuraci√≥n del Entorno

### Requisitos Previos

```bash
# Instalar k6
sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg \
  --keyserver hkp://keyserver.ubuntu.com:80 \
  --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69

echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | \
  sudo tee /etc/apt/sources.list.d/k6.list

sudo apt-get update && sudo apt-get install k6

# Instalar herramientas adicionales
sudo apt-get install -y jq bc curl
```

### Variables de Entorno

```bash
# Configuraci√≥n por ambiente
export ENVIRONMENT="development"     # development|staging|production
export TEST_TYPE="load"             # smoke|load|stress|websocket|blockchain|all
export PARALLEL_TESTS="false"       # true para ejecuci√≥n paralela
export GENERATE_REPORTS="true"      # Generar reportes HTML

# Notificaciones (opcional)
export SLACK_WEBHOOK="https://hooks.slack.com/..."
export DISCORD_WEBHOOK="https://discord.com/api/webhooks/..."
```

### Configuraci√≥n de L√≠mites del Sistema

```bash
# Aumentar l√≠mites para pruebas de estr√©s
ulimit -n 65536                    # Archivos abiertos
sysctl -w net.core.somaxconn=65536  # Conexiones socket
```

---

## üöÄ Ejecuci√≥n de Pruebas

### Ejecuci√≥n Local

#### Pruebas B√°sicas
```bash
# Smoke test r√°pido
./performance/scripts/run-performance-tests.sh -e development -t smoke

# Pruebas de carga completas
./performance/scripts/run-performance-tests.sh -e staging -t load

# Todas las pruebas en paralelo
./performance/scripts/run-performance-tests.sh -e staging -t all -p
```

#### Pruebas Espec√≠ficas
```bash
# Solo WebSocket
k6 run --env ENVIRONMENT=development performance/k6/tests/websocket-test.js

# Solo blockchain con configuraci√≥n custom
k6 run \
  --env ENVIRONMENT=staging \
  --env SCENARIO=stress \
  performance/k6/tests/blockchain-stress-test.js
```

### Ejecuci√≥n en CI/CD

Las pruebas se ejecutan autom√°ticamente en:

- **Push a main/develop**: Smoke + Load tests
- **Pull Requests**: Smoke tests
- **Schedule diario**: Todas las pruebas
- **Manual**: Configuraci√≥n personalizada

```yaml
# Trigger manual en GitHub Actions
on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        options: ['development', 'staging', 'production']
      test_type:
        type: choice
        options: ['smoke', 'load', 'stress', 'all']
```

---

## üìä An√°lisis de Resultados

### M√©tricas Autom√°ticas

Cada ejecuci√≥n genera:

1. **üìÑ Resumen JSON**: `results/test_summary_TIMESTAMP.json`
2. **üìã Log detallado**: `results/test_TIMESTAMP.log`
3. **üåê Reporte HTML**: `results/consolidated_report_TIMESTAMP.html`

### Interpretaci√≥n de M√©tricas

#### ‚úÖ Criterios de √âxito
```javascript
// Umbrales autom√°ticos en k6
thresholds: {
  'http_req_duration': ['p(95)<500'],      // 95% requests < 500ms
  'http_req_failed': ['rate<0.01'],        // < 1% error rate
  'http_reqs': ['rate>100'],               // > 100 req/s throughput
  'websocket_message_latency': ['p(95)<100'] // WebSocket < 100ms
}
```

#### üìà An√°lisis de Tendencias
```bash
# Comparar resultados hist√≥ricos
jq '.metrics.http_req_duration.p95' performance/results/*_summary.json | \
  awk '{sum+=$1; count++} END {print "Avg P95:", sum/count "ms"}'

# Identificar degradaci√≥n
jq '.metrics.http_req_failed.rate * 100' performance/results/*_summary.json | \
  tail -5  # √öltimas 5 ejecuciones
```

### Dashboard de Monitoreo

Acceso al dashboard en tiempo real:
```
üåê Grafana: http://localhost:3000/d/arbitragex-performance
üìä Prometheus: http://localhost:9090
üîç Alertmanager: http://localhost:9093
```

---

## ‚ö° Optimizaci√≥n de Rendimiento

### Identificaci√≥n de Bottlenecks

#### 1. An√°lisis de Latencia
```bash
# Top endpoints m√°s lentos
jq -r '.metrics | to_entries[] | select(.key | contains("duration")) | 
       "\(.key): \(.value.p95)ms"' results/summary.json | sort -k2 -n
```

#### 2. An√°lisis de Errores
```bash
# Endpoints con m√°s errores
jq -r '.metrics | to_entries[] | select(.key | contains("failed")) | 
       "\(.key): \(.value.rate * 100)%"' results/summary.json
```

#### 3. An√°lisis de Throughput
```bash
# Capacidad por endpoint
jq -r '.metrics | to_entries[] | select(.key | contains("reqs") and (.key | contains("rate"))) | 
       "\(.key): \(.value) req/s"' results/summary.json
```

### Estrategias de Optimizaci√≥n

#### Base de Datos
- **Connection Pooling**: Configurar pools √≥ptimos
- **Query Optimization**: Indexar consultas frecuentes
- **Caching**: Redis para datos accedidos frecuentemente

```javascript
// Configuraci√≥n optimizada de pool
database: {
  pool: {
    min: 5,
    max: 20,
    acquireTimeoutMillis: 30000,
    createTimeoutMillis: 30000,
    destroyTimeoutMillis: 5000,
    idleTimeoutMillis: 30000
  }
}
```

#### APIs
- **Response Compression**: Gzip/Brotli
- **Pagination**: Limitar respuestas grandes
- **Caching Headers**: ETags y Cache-Control

```javascript
// Headers de optimizaci√≥n
headers: {
  'Cache-Control': 'public, max-age=300',
  'Content-Encoding': 'gzip',
  'ETag': generateETag(data)
}
```

#### WebSocket
- **Connection Pooling**: Reutilizar conexiones
- **Message Batching**: Agrupar mensajes peque√±os
- **Heartbeat Optimization**: Intervalos eficientes

```javascript
// Configuraci√≥n WebSocket optimizada
websocket: {
  maxConnections: 1000,
  heartbeatInterval: 30000,
  messageBufferSize: 1000,
  compressionEnabled: true
}
```

#### Blockchain
- **RPC Load Balancing**: Distribuir entre providers
- **Request Batching**: Agrupar llamadas RPC
- **Intelligent Caching**: Cache inteligente de datos blockchain

```javascript
// Configuraci√≥n RPC optimizada
blockchain: {
  providers: {
    ethereum: ['alchemy', 'infura', 'quicknode'],
    loadBalancing: 'round-robin',
    retryAttempts: 3,
    timeout: 10000
  }
}
```

---

## üîÑ CI/CD Integration

### Pipeline Automatizado

El pipeline de performance se ejecuta en paralelo con el deployment:

```mermaid
graph LR
    A[Code Push] --> B[Unit Tests]
    B --> C[Build & Deploy]
    C --> D[Smoke Tests]
    D --> E{Deploy OK?}
    E -->|Yes| F[Load Tests]
    E -->|No| G[Rollback]
    F --> H[Performance Report]
    H --> I[Slack/Discord Alert]
```

### Criterios de Bloqueo

Las pruebas bloquean deployment si:

- **Smoke tests fallan**: Funcionalidad b√°sica rota
- **Error rate > 5%**: Sistema inestable
- **P95 latency > 2000ms**: Rendimiento inaceptable
- **Throughput < 50 req/s**: Capacidad insuficiente

### Configuraci√≥n de Alerts

```yaml
# .github/workflows/performance-testing.yml
- name: 'Block Deployment on Critical Failure'
  if: needs.smoke-tests.result == 'failure'
  run: |
    echo "üö® CRITICAL: Smoke tests failed - blocking deployment"
    exit 1
```

---

## üìà Monitoreo Continuo

### M√©tricas en Producci√≥n

#### SLIs (Service Level Indicators)
- **Availability**: 99.9% uptime
- **Latency**: P95 < 500ms para APIs cr√≠ticas
- **Throughput**: > 100 req/s peak capacity
- **Error Rate**: < 0.1% en operaciones de trading

#### SLOs (Service Level Objectives)
```prometheus
# Alertas Prometheus
groups:
  - name: arbitragex.performance
    rules:
      - alert: HighLatency
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 0.5
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High latency detected"
          
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) > 0.01
        for: 1m
        labels:
          severity: critical
```

### Dashboard de M√©tricas

El dashboard incluye:

- **üìä System Overview**: M√©tricas generales
- **‚ö° Trading Performance**: Espec√≠fico de arbitraje
- **üîå WebSocket Health**: Conexiones tiempo real
- **‚õìÔ∏è Blockchain Status**: Estado multi-cadena
- **üõ°Ô∏è MEV Protection**: An√°lisis de amenazas

---

## üîß Troubleshooting

### Problemas Comunes

#### 1. Tests Fallan por Timeout
```bash
# Verificar conectividad
curl -w "@curl-format.txt" -o /dev/null -s "http://localhost:3000/health"

# Aumentar timeouts en k6
k6 run --http-debug --timeout 60s test.js
```

#### 2. WebSocket Desconexiones
```javascript
// Configurar reconnection
socket.onclose = function(event) {
  if (!event.wasClean) {
    console.log('Connection lost, reconnecting...');
    setTimeout(connect, 1000);
  }
};
```

#### 3. Blockchain RPC Errors
```bash
# Verificar status de proveedores
curl -X POST -H "Content-Type: application/json" \
  --data '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}' \
  https://eth-mainnet.alchemyapi.io/v2/YOUR_API_KEY
```

#### 4. Memoria Insuficiente k6
```bash
# Ejecutar con l√≠mites ajustados
k6 run --vus 50 --duration 2m test.js  # Reducir VUs
k6 run --max-redirects 3 test.js       # Limitar redirects
```

### Logs y Debugging

#### Habilitar Logs Detallados
```bash
# Debug completo k6
K6_DEBUG=true k6 run --http-debug test.js

# Logs espec√≠ficos por m√≥dulo
K6_LOG_LEVEL=debug k6 run test.js 2>&1 | grep -E "(websocket|blockchain)"
```

#### An√°lisis de Performance
```bash
# Profiling del sistema durante pruebas
top -p $(pgrep k6) -d 1           # CPU usage
iotop -p $(pgrep k6)             # I/O usage  
nethogs                          # Network usage
```

---

## üéØ Best Practices

### Desarrollo de Tests

1. **üîÑ Iterativo**: Desarrollar tests incrementalmente
2. **üìä Data-driven**: Usar datos realistas de producci√≥n
3. **üéØ Espec√≠fico**: Tests focalizados por funcionalidad
4. **‚ö° Eficiente**: Optimizar uso de recursos en tests
5. **üìà Evolutivo**: Actualizar tests con nuevas features

### Ejecuci√≥n de Tests

1. **üïê Horarios**: Ejecutar en horarios de bajo tr√°fico
2. **üîÄ Aleatorio**: Usar datos y patrones aleatorios
3. **‚öñÔ∏è Balanceado**: Distribuir carga uniformemente
4. **üéØ Objetivo**: Tests con objetivos claros y medibles
5. **üìã Documentado**: Registrar configuraci√≥n y resultados

### An√°lisis de Resultados

1. **üìà Tendencias**: Monitorear evoluci√≥n hist√≥rica
2. **üéØ Umbrales**: Definir criterios objetivos
3. **üîç Root Cause**: Investigar causas de degradaci√≥n
4. **üöÄ Acci√≥n**: Tomar acciones correctivas inmediatas
5. **üìä Reporte**: Comunicar resultados efectivamente

---

## üìö Referencias

### Documentaci√≥n T√©cnica
- [k6 Documentation](https://k6.io/docs/)
- [Prometheus Monitoring](https://prometheus.io/docs/)
- [Grafana Dashboards](https://grafana.com/docs/)

### M√©tricas de Referencia
- [Google SRE Book](https://sre.google/sre-book/)
- [Performance Testing Guidelines](https://martinfowler.com/articles/practical-test-pyramid.html)

### Ingenio Pichichi S.A.
- **Metodolog√≠a**: "Cumplidor, disciplinado, organizado"
- **Est√°ndares**: Todo funcional sin mocks
- **Calidad**: Testing empresarial de clase mundial

---

## ‚úÖ Checklist de Implementaci√≥n

- [ ] k6 instalado y configurado
- [ ] Tests b√°sicos ejecut√°ndose correctamente
- [ ] CI/CD pipeline configurado
- [ ] Dashboard de monitoreo activo
- [ ] Alertas configuradas y probadas
- [ ] Documentaci√≥n actualizada
- [ ] Equipo entrenado en herramientas
- [ ] Umbrales de rendimiento definidos
- [ ] Proceso de escalaci√≥n establecido
- [ ] Revisi√≥n peri√≥dica programada

---

**üè≠ Ingenio Pichichi S.A. - ArbitrageX Supreme Performance Testing**

*Este documento representa el est√°ndar de testing de rendimiento empresarial para sistemas de trading DeFi, aplicando metodolog√≠as disciplinadas y organizadas sin comprometer la funcionalidad real del sistema.*